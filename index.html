<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Complex Purple Tic Tac Toe</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');
  body {
    margin: 0; background: #2e0854;
    color: #cbb8ff; font-family: 'Roboto Mono', monospace;
    display: flex; flex-direction: column; align-items: center; min-height: 100vh;
    user-select: none;
  }
  h1 {
    margin: 20px 0 5px 0;
    color: #d1b3ff;
    text-shadow: 0 0 10px #8e44ad;
  }
  #gameContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-template-rows: repeat(3, 100px);
    gap: 8px;
    margin: 15px 0;
  }
  .cell {
    width: 100px; height: 100px;
    background: linear-gradient(145deg, #3c1e72, #250a49);
    border-radius: 15px;
    box-shadow: inset 4px 4px 6px #1a0630, inset -4px -4px 6px #4d1ca5;
    display: flex; align-items: center; justify-content: center;
    font-size: 64px; color: #bda6ff;
    cursor: pointer;
    position: relative;
    transition: background-color 0.3s ease;
  }
  .cell:hover {
    background: linear-gradient(145deg, #4d2ea4, #3a1f74);
  }
  .cell.occupied {
    cursor: default;
    color: #d9cfff;
  }
  .cell.win {
    animation: glow 1.5s ease-in-out infinite alternate;
  }
  @keyframes glow {
    0% {
      box-shadow: 0 0 10px 4px #b07eff;
      color: #d1b3ff;
    }
    100% {
      box-shadow: 0 0 25px 10px #a16eff;
      color: #f4e1ff;
    }
  }
  #message {
    margin-top: 10px;
    font-size: 18px;
    min-height: 24px;
    text-align: center;
  }
  #controls {
    display: flex; gap: 10px; margin-top: 15px;
  }
  button {
    background: #5e3dbd;
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    font-size: 16px;
    color: #d9cfff;
    cursor: pointer;
    box-shadow: 0 4px 8px #3a2574;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background: #3d2777;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #8a5efd;
  }
  #scoreboard {
    margin-top: 20px;
    font-size: 16px;
    color: #cbb8ff;
    text-align: center;
  }
  #history-controls {
    margin-top: 20px;
    color: #cbb8ff;
    width: 320px;
    font-size: 14px;
  }
  #moveHistory {
    margin-top: 10px;
    max-height: 120px;
    overflow-y: auto;
    background: #3b2770;
    border-radius: 8px;
    padding: 8px;
  }
  #moveHistory div {
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 5px;
    user-select: none;
  }
  #moveHistory div:hover {
    background-color: #704fc1;
  }
  #moveHistory .active {
    background-color: #a678ff;
    font-weight: bold;
  }
  #timer {
    margin-top: 10px;
    font-size: 16px;
    color: #d1b3ff;
    font-weight: 600;
  }
</style>
</head>
<body>

<h1>Complex Purple Tic Tac Toe</h1>
<div id="gameContainer">
  <div id="board" aria-label="Tic Tac Toe Board" role="grid"></div>
  <div id="message" aria-live="polite"></div>
  <div id="timer"></div>
  <div id="controls">
    <button id="undoBtn" disabled>Undo</button>
    <button id="redoBtn" disabled>Redo</button>
    <button id="restartBtn">Restart</button>
  </div>
  <div id="scoreboard">
    <div>Player X Wins: <span id="scoreX">0</span></div>
    <div>Player O Wins: <span id="scoreO">0</span></div>
    <div>Draws: <span id="scoreDraw">0</span></div>
  </div>
  <div id="history-controls">
    <div><strong>Move History (click to jump):</strong></div>
    <div id="moveHistory"></div>
  </div>
</div>

<script>
(() => {
  const boardEl = document.getElementById('board');
  const messageEl = document.getElementById('message');
  const timerEl = document.getElementById('timer');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const restartBtn = document.getElementById('restartBtn');
  const scoreXEl = document.getElementById('scoreX');
  const scoreOEl = document.getElementById('scoreO');
  const scoreDrawEl = document.getElementById('scoreDraw');
  const moveHistoryEl = document.getElementById('moveHistory');

  const gridSize = 3;
  let board = new Array(gridSize * gridSize).fill(null);
  let currentPlayer = 'X';
  let gameActive = true;

  // Scores
  let scores = {
    X: 0,
    O: 0,
    draws: 0,
  };

  // History states: each element {board: [...], currentPlayer: 'X'|'O', moveIndex: number|null}
  let history = [];
  let historyIndex = -1;

  // Timer stuff
  let turnTime = 10; // seconds per turn
  let timerId = null;
  let timerRemaining = turnTime;

  // Create the board UI
  function createBoard() {
    boardEl.innerHTML = '';
    boardEl.style.gridTemplateColumns = `repeat(${gridSize}, 100px)`;
    boardEl.style.gridTemplateRows = `repeat(${gridSize}, 100px)`;
    for(let i = 0; i < gridSize * gridSize; i++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');
      cell.setAttribute('role', 'button');
      cell.setAttribute('aria-label', `Cell ${i + 1}`);
      cell.dataset.index = i;
      cell.addEventListener('click', () => handleCellClick(i));
      boardEl.appendChild(cell);
    }
  }

  function renderBoard() {
    for(let i = 0; i < board.length; i++) {
      const cell = boardEl.children[i];
      const val = board[i];
      cell.textContent = val || '';
      cell.classList.toggle('occupied', val !== null);
      cell.classList.remove('win');
    }
  }

  function highlightWinningCells(winningCells) {
    winningCells.forEach(i => {
      boardEl.children[i].classList.add('win');
    });
  }

  // Returns array of indices if win, else null
  function checkWin(player) {
    const lines = [
      // horizontals
      [0,1,2], [3,4,5], [6,7,8],
      // verticals
      [0,3,6], [1,4,7], [2,5,8],
      // diagonals
      [0,4,8], [2,4,6]
    ];
    for(const line of lines) {
      if(line.every(i => board[i] === player)) return line;
    }
    return null;
  }

  function isDraw() {
    return board.every(cell => cell !== null);
  }

  // Add a new state to history and update pointer
  function addHistory(boardState, player, moveIndex) {
    if(historyIndex < history.length - 1) {
      history.splice(historyIndex + 1);
    }
    history.push({
      board: boardState.slice(),
      currentPlayer: player,
      moveIndex: moveIndex
    });
    historyIndex = history.length - 1;
    updateHistoryControls();
    renderMoveHistory();
  }

  function renderMoveHistory() {
    moveHistoryEl.innerHTML = '';
    history.forEach((h, i) => {
      let text = i === 0 ? 'Game Start' : `Move #${i}: Player ${h.currentPlayer === 'X' ? 'O' : 'X'} placed`;
      if (h.moveIndex !== null) {
        const row = Math.floor(h.moveIndex / gridSize) + 1;
        const col = (h.moveIndex % gridSize) + 1;
        text += ` at (${row},${col})`;
      }
      const div = document.createElement('div');
      div.textContent = text;
      div.classList.toggle('active', i === historyIndex);
      div.addEventListener('click', () => {
        historyIndex = i;
        loadHistoryState();
        resetTimer();
      });
      moveHistoryEl.appendChild(div);
    });
  }

  // Load a board state from history at historyIndex
  function loadHistoryState() {
    const state = history[historyIndex];
    board = state.board.slice();
    currentPlayer = state.currentPlayer;
    gameActive = historyIndex === history.length -1;
    renderBoard();
    updateMessage();
    updateControls();
  }

  function updateMessage() {
    if(!gameActive) {
      if(checkWin(currentPlayer === 'X' ? 'O' : 'X')) {
        messageEl.textContent = `Player ${currentPlayer === 'X' ? 'O' : 'X'} wins!`;
      } else if(isDraw()) {
        messageEl.textContent = "It's a draw!";
      } else {
        messageEl.textContent = `Viewing past move #${historyIndex}`;
      }
    } else {
      messageEl.textContent = `Player ${currentPlayer}'s turn`;
    }
  }

  // Handle user clicking on cell
  function handleCellClick(i) {
    if(!gameActive) return;
    if(board[i] !== null) return;

    board[i] = currentPlayer;
    addHistory(board, currentPlayer === 'X' ? 'O' : 'X', i);
    renderBoard();

    const winningCells = checkWin(currentPlayer);
    if(winningCells) {
      gameActive = false;
      highlightWinningCells(winningCells);
      messageEl.textContent = `Player ${currentPlayer} wins!`;
      scores[currentPlayer]++;
      updateScoreboard();
      stopTimer();
      return;
    }

    if(isDraw()) {
      gameActive = false;
      messageEl.textContent = "It's a draw!";
      scores.draws++;
      updateScoreboard();
      stopTimer();
      return;
    }

    currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
    updateMessage();
    updateControls();
    resetTimer();
  }

  function updateScoreboard() {
    scoreXEl.textContent = scores.X;
    scoreOEl.textContent = scores.O;
    scoreDrawEl.textContent = scores.draws;
  }

  // Undo and redo buttons
  function undoMove() {
    if(historyIndex > 0) {
      historyIndex--;
      loadHistoryState();
      resetTimer();
    }
  }
  function redoMove() {
    if(historyIndex < history.length - 1) {
      historyIndex++;
      loadHistoryState();
      resetTimer();
    }
  }
  undoBtn.addEventListener('click', undoMove);
  redoBtn.addEventListener('click', redoMove);

  // Restart game
  restartBtn.addEventListener('click', () => {
    initGame();
  });

  function updateHistoryControls() {
    undoBtn.disabled = historyIndex <= 0;
    redoBtn.disabled = historyIndex >= history.length - 1;
  }

  function updateControls() {
    undoBtn.disabled = historyIndex <= 0;
    redoBtn.disabled = historyIndex >= history.length - 1;
  }

  // Timer Functions
  function startTimer() {
    timerRemaining = turnTime;
    timerEl.textContent = `Time left: ${timerRemaining}s`;
    if(timerId) clearInterval(timerId);
    timerId = setInterval(() => {
      timerRemaining--;
      timerEl.textContent = `Time left: ${timerRemaining}s`;
      if(timerRemaining <= 0) {
        clearInterval(timerId);
        timerEl.textContent = `Time's up! Switching turn.`;
        forceSwitchTurn();
      }
    }, 1000);
  }
  function resetTimer() {
    if(gameActive) {
      startTimer();
    } else {
      clearInterval(timerId);
      timerEl.textContent = '';
    }
  }
  function stopTimer() {
    clearInterval(timerId);
    timerEl.textContent = '';
  }
  // If time runs out, switch turn automatically
  function forceSwitchTurn() {
    if(!gameActive) return;
    currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
    messageEl.textContent = `Player ${currentPlayer}'s turn (time penalty)`;
    updateControls();
    resetTimer();
  }

  // Initialize a fresh game
  function initGame() {
    board = new Array(gridSize * gridSize).fill(null);
    currentPlayer = 'X';
    gameActive = true;
    history = [];
    historyIndex = -1;
    addHistory(board, currentPlayer, null);
    renderBoard();
    updateScoreboard();
    updateMessage();
    updateControls();
    resetTimer();
  }

  createBoard();
  initGame();

})();
</script>

</body>
</html>
